#!/usr/bin/env bash
# Debian 11 ä¸€é”®éƒ¨ç½²è„šæœ¬
# - åˆå§‹åŒ–ç³»ç»Ÿ & å†…æ ¸
# - VLESS Reality (SNI=www.apple.com)
# - Hysteria2 å®˜æ–¹æç®€ (SNI=www.apple.com)
# - Hy2 ä¸´æ—¶èŠ‚ç‚¹ + å®¡è®¡ + GCï¼ˆç»å¯¹æ—¶é—´ TTLï¼‰
# - nftables UDP ä¸Šè¡Œé…é¢ç³»ç»Ÿï¼ˆè‡ªåŠ¨æŒä¹…åŒ– + 1 åˆ†é’Ÿä¿å­˜å¿«ç…§ï¼‰

set -euo pipefail

REPO_BASE="https://raw.githubusercontent.com/liucong552-art/debian12-/main"
UP_BASE="/usr/local/src/debian12-upstream"

# ------------------ å…¬å…±å‡½æ•° ------------------

check_debian11() {
  if [[ "$(id -u)" -ne 0 ]]; then
    echo "âŒ è¯·ä»¥ root è¿è¡Œæœ¬è„šæœ¬"
    exit 1
  fi
  local codename
  codename=$(grep -E "^VERSION_CODENAME=" /etc/os-release 2>/dev/null | cut -d= -f2)
  if [[ "$codename" != "bullseye" ]]; then
    echo "âŒ æœ¬è„šæœ¬ä»…é€‚ç”¨äº Debian 11 (bullseye)ï¼Œå½“å‰: ${codename:-æœªçŸ¥}"
    exit 1
  fi
}

need_basic_tools() {
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y || true
  apt-get install -y curl wget openssl python3 nftables || apt-get install -y curl wget openssl
}

download_upstreams() {
  echo "â¬‡ ä¸‹è½½/æ›´æ–° ä¸Šæ¸¸æ–‡ä»¶åˆ° ${UP_BASE} ..."
  mkdir -p "$UP_BASE"

  # Xray å®‰è£…è„šæœ¬
  curl -fsSL "${REPO_BASE}/xray-install-release.sh" -o "${UP_BASE}/xray-install-release.sh"
  chmod +x "${UP_BASE}/xray-install-release.sh"

  # Hysteria å®‰è£…è„šæœ¬
  curl -fsSL "${REPO_BASE}/hysteria-install.sh" -o "${UP_BASE}/hysteria-install.sh"
  chmod +x "${UP_BASE}/hysteria-install.sh"

  echo "âœ… ä¸Šæ¸¸å·²æ›´æ–°ï¼š"
  ls -l "$UP_BASE"
}

# ------------------ 1. ç³»ç»Ÿæ›´æ–° + æ–°å†…æ ¸ ------------------

install_update_all() {
  echo "ğŸ§© å†™å…¥ /usr/local/bin/update-all ..."
  cat >/usr/local/bin/update-all << 'EOF'
#!/bin/bash
set -e

check_debian11() {
  if [ "$(id -u)" -ne 0 ]; then
    echo "âŒ è¯·ä»¥ root èº«ä»½è¿è¡Œæœ¬è„šæœ¬"; exit 1
  fi
  local codename
  codename=$(grep -E "^VERSION_CODENAME=" /etc/os-release 2>/dev/null | cut -d= -f2)
  if [ "$codename" != "bullseye" ]; then
    echo "âŒ æœ¬è„šæœ¬ä»…é€‚ç”¨äº Debian 11 (bullseye)ï¼Œå½“å‰ä¸º: ${codename:-æœªçŸ¥}"
    exit 1
  fi
}

check_debian11
echo "ğŸš€ å¼€å§‹ç³»ç»Ÿæ›´æ–° (Debian 11 / bullseye)..."

export DEBIAN_FRONTEND=noninteractive

apt-get update -y
apt-get full-upgrade -y
apt-get --purge autoremove -y
apt-get autoclean -y
apt-get clean -y

echo "âœ… è½¯ä»¶åŒ…æ›´æ–°å®Œæˆ"

echo "ğŸ§± é…ç½® bullseye-backports ä»“åº“..."
BACKPORTS_FILE=/etc/apt/sources.list.d/backports.list
if [ -f "$BACKPORTS_FILE" ]; then
  cp "$BACKPORTS_FILE" "${BACKPORTS_FILE}.bak.$(date +%F-%H%M%S)"
fi
cat >"$BACKPORTS_FILE" <<BEOF
deb http://deb.debian.org/debian bullseye-backports main contrib non-free
BEOF

apt-get update -y

echo "ğŸ”§ ä» backports å®‰è£…æœ€æ–°å†…æ ¸ (linux-image-amd64 / linux-headers-amd64)..."
apt-get -t bullseye-backports install -y linux-image-amd64 linux-headers-amd64

echo
echo "ğŸ“¦ å½“å‰å·²å®‰è£…çš„å†…æ ¸åŒ… (linux-image)ï¼š"
dpkg -l | grep "^ii  linux-image" | tail -n 10 || true

echo
echo "ğŸ–¥ å½“å‰æ­£åœ¨è¿è¡Œçš„å†…æ ¸ï¼š$(uname -r)"
echo "âš ï¸ é‡å¯åç³»ç»Ÿæ‰ä¼šçœŸæ­£åˆ‡æ¢åˆ°æ–°å†…æ ¸ï¼Œè¯·æ‰§è¡Œï¼šreboot"
EOF

  chmod +x /usr/local/bin/update-all
}

# ------------------ 2. VLESS Reality ä¸€é”® ------------------

install_vless_script() {
  echo "ğŸ§© å†™å…¥ /root/onekey_reality_ipv4.sh ..."
  cat >/root/onekey_reality_ipv4.sh << 'EOF'
#!/usr/bin/env bash
set -e

REPO_BASE="https://raw.githubusercontent.com/liucong552-art/debian12-/main"
UP_BASE="/usr/local/src/debian12-upstream"

check_debian11() {
  if [ "$(id -u)" -ne 0 ]; then
    echo "âŒ è¯·ä»¥ root èº«ä»½è¿è¡Œ"; exit 1
  fi
  local codename
  codename=$(grep -E "^VERSION_CODENAME=" /etc/os-release 2>/dev/null | cut -d= -f2)
  if [ "$codename" != "bullseye" ]; then
    echo "âŒ ä»…æ”¯æŒ Debian 11 (bullseye)ï¼Œå½“å‰: ${codename:-æœªçŸ¥}"
    exit 1
  fi
}

install_xray_from_local_or_repo() {
  mkdir -p "$UP_BASE"
  local xray_installer="$UP_BASE/xray-install-release.sh"
  if [ ! -x "$xray_installer" ]; then
    echo "â¬‡ ä»ä»“åº“è·å– Xray å®‰è£…è„šæœ¬..."
    curl -fsSL "$REPO_BASE/xray-install-release.sh" -o "$xray_installer"
    chmod +x "$xray_installer"
  fi
  echo "âš™ å®‰è£… / æ›´æ–° Xray-core..."
  "$xray_installer" install --without-geodata
  if [ ! -x /usr/local/bin/xray ]; then
    echo "âŒ æœªæ‰¾åˆ° /usr/local/bin/xrayï¼Œè¯·æ£€æŸ¥å®‰è£…è„šæœ¬"; exit 1
  fi
}

check_debian11

REALITY_DOMAIN="www.apple.com"
PORT=443
NODE_NAME="VLESS-REALITY-IPv4-APPLE"

SERVER_IP=$(curl -4fsS https://ifconfig.me \
        || curl -4fsS https://api.ipify.org \
        || hostname -I | awk '{print $1}')
if [[ -z "$SERVER_IP" ]]; then
  echo "âŒ æ— æ³•æ£€æµ‹ IPv4 å…¬ç½‘ IP"; exit 1
fi

echo "æœåŠ¡å™¨ IPv4: $SERVER_IP"
echo "ä¼ªè£…åŸŸå:   $REALITY_DOMAIN"
echo "ç«¯å£:       $PORT"
sleep 2

echo "=== 1. å¯ç”¨ BBR ==="
cat >/etc/sysctl.d/99-bbr.conf <<SYS
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr
SYS
modprobe tcp_bbr 2>/dev/null || true
sysctl -p /etc/sysctl.d/99-bbr.conf || true
echo "å½“å‰æ‹¥å¡æ§åˆ¶: $(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo unknown)"

echo
echo "=== 2. å®‰è£… / æ›´æ–° Xray-core ==="
install_xray_from_local_or_repo
systemctl stop xray 2>/dev/null || true

echo
echo "=== 3. ç”Ÿæˆ UUID ä¸ Reality å¯†é’¥ ==="
/usr/local/bin/xray uuid >/tmp/xray_uuid.txt
UUID=$(cat /tmp/xray_uuid.txt)

KEY_OUT=$(/usr/local/bin/xray x25519)

PRIVATE_KEY=$(
  printf '%s\n' "$KEY_OUT" | awk '
    /^PrivateKey:/   {print $2; exit}
    /^Private key:/  {print $3; exit}
  '
)

PUBLIC_KEY=$(
  printf '%s\n' "$KEY_OUT" | awk '
    # æ—§ç‰ˆ: æ˜¾ç¤ºä¸º PublicKey:/Public key:
    /^PublicKey:/    {print $2; exit}
    /^Public key:/   {print $3; exit}
    # æ–°ç‰ˆ (2025.10+): æŠŠåŸå…ˆ PublicKey é‡å‘½åä¸º Password:
    /^Password:/     {print $2; exit}
  '
)

if [[ -z "$PRIVATE_KEY" || -z "$PUBLIC_KEY" ]]; then
  echo "âŒ æ— æ³•è§£æ Reality å¯†é’¥ï¼š"
  echo "$KEY_OUT"
  exit 1
fi

SHORT_ID=$(openssl rand -hex 8)

CONFIG_DIR=/usr/local/etc/xray
mkdir -p "$CONFIG_DIR"

cat >"$CONFIG_DIR/config.json" <<CONF
{
  "log": { "loglevel": "warning" },
  "inbounds": [
    {
      "listen": "0.0.0.0",
      "port": $PORT,
      "protocol": "vless",
      "settings": {
        "clients": [
          { "id": "$UUID", "flow": "xtls-rprx-vision" }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "dest": "$REALITY_DOMAIN:443",
          "xver": 0,
          "serverNames": [ "$REALITY_DOMAIN" ],
          "privateKey": "$PRIVATE_KEY",
          "shortIds": [ "$SHORT_ID" ]
        }
      },
      "sniffing": {
        "enabled": true,
        "routeOnly": true,
        "destOverride": ["http","tls","quic"]
      }
    }
  ],
  "outbounds": [
    { "tag": "direct", "protocol": "freedom" },
    { "tag": "block",  "protocol": "blackhole" }
  ]
}
CONF

systemctl daemon-reload
systemctl enable xray || true
systemctl restart xray
sleep 2
systemctl --no-pager --full status xray || true

VLESS_URL="vless://${UUID}@${SERVER_IP}:${PORT}?type=tcp&security=reality&encryption=none&flow=xtls-rprx-vision&sni=${REALITY_DOMAIN}&fp=chrome&pbk=${PUBLIC_KEY}&sid=${SHORT_ID}#${NODE_NAME}"

if base64 --help 2>/dev/null | grep -q -- "-w"; then
  echo "$VLESS_URL" | base64 -w0 >/root/v2ray_subscription_base64.txt
else
  echo "$VLESS_URL" | base64 | tr -d '\n' >/root/v2ray_subscription_base64.txt
fi
echo "$VLESS_URL" >/root/vless_reality_vision_url.txt

echo
echo "================== èŠ‚ç‚¹ä¿¡æ¯ =================="
echo "$VLESS_URL"
echo
echo "Base64 è®¢é˜…ï¼š"
cat /root/v2ray_subscription_base64.txt
echo
echo "ä¿å­˜ä½ç½®ï¼š"
echo "  /root/vless_reality_vision_url.txt"
echo "  /root/v2ray_subscription_base64.txt"
echo "âœ… VLESS+Reality+Vision (IPv4, SNI=www.apple.com) å®‰è£…å®Œæˆ"
EOF

  chmod +x /root/onekey_reality_ipv4.sh
}

# ------------------ 3. Hy2 å®˜æ–¹æç®€ ä¸€é”® ------------------

install_hy2_script() {
  echo "ğŸ§© å†™å…¥ /root/hy2_official_minimal_ipv4.sh ..."
  cat >/root/hy2_official_minimal_ipv4.sh << 'EOF'
#!/usr/bin/env bash
set -euo pipefail

REPO_BASE="https://raw.githubusercontent.com/liucong552-art/debian12-/main"
UP_BASE="/usr/local/src/debian12-upstream"

check_debian11() {
  if [[ "$(id -u)" -ne 0 ]]; then
    echo "âŒ è¯·ä»¥ root è¿è¡Œ"; exit 1
  fi
  local codename
  codename=$(grep -E "^VERSION_CODENAME=" /etc/os-release 2>/dev/null | cut -d= -f2)
  if [[ "$codename" != "bullseye" ]]; then
    echo "âŒ ä»…æ”¯æŒ Debian 11 (bullseye)ï¼Œå½“å‰: ${codename:-æœªçŸ¥}"
    exit 1
  fi
}

install_hysteria_from_local_or_repo() {
  mkdir -p "$UP_BASE"
  local hy_installer="$UP_BASE/hysteria-install.sh"
  if [[ ! -x "$hy_installer" ]]; then
    echo "â¬‡ ä»ä»“åº“è·å– Hysteria å®‰è£…è„šæœ¬..."
    curl -fsSL "$REPO_BASE/hysteria-install.sh" -o "$hy_installer"
    chmod +x "$hy_installer"
  fi
  echo "âš™ å®‰è£… / æ›´æ–° Hysteria2..."
  "$hy_installer"
}

check_debian11

HY_PORT=8443
SNI_HOST=www.apple.com

echo "== [1] å®‰è£…ä¾èµ–ï¼ˆä¸æ”¹è½¯ä»¶æºï¼‰ =="
apt-get update -y || true
apt-get install -y curl openssl python3 || apt-get install -y curl openssl

echo "== [2] å®‰è£… Hysteria2ï¼ˆæœ¬åœ°æˆ–ä»“åº“è„šæœ¬ï¼‰ =="
install_hysteria_from_local_or_repo

echo "== [3] è·å– IPv4 å…¬ç½‘ IP å’Œéšæœºå¯†ç  =="
PUB_IP=$(curl -4fsS https://ifconfig.me || hostname -I | awk '{print $1}')
HY_PASS=$(openssl rand -base64 18 | tr -d "=/+")
echo "å…¬ç½‘ IP: ${PUB_IP}"
echo "Hy2 å¯†ç : ${HY_PASS}"

install -d -m 0755 /etc/hysteria

echo "== [4] ç”Ÿæˆ EC è‡ªç­¾è¯ä¹¦ï¼ˆCN = ${SNI_HOST}ï¼‰ =="
openssl ecparam -genkey -name prime256v1 -out /etc/hysteria/server.key
openssl req -x509 -new -key /etc/hysteria/server.key \
  -out /etc/hysteria/server.crt \
  -days 3650 \
  -subj "/CN=${SNI_HOST}"

echo "== [5] å†™å…¥å®˜æ–¹æç®€ç‰ˆé…ç½®ï¼ˆIPv4 ä¼˜å…ˆ + QUIC ä¼˜åŒ–ï¼‰ =="
cat >/etc/hysteria/config.yaml <<CFG
listen: :${HY_PORT}

tls:
  cert: /etc/hysteria/server.crt
  key: /etc/hysteria/server.key

auth:
  type: password
  password: ${HY_PASS}

quic:
  alpn:
    - h3
    - h3-29
  initStreamReceiveWindow: 26843545
  maxStreamReceiveWindow: 26843545
  initConnReceiveWindow: 67108864
  maxConnReceiveWindow: 67108864
  maxIdleTimeout: 30s
  maxIncomingStreams: 1024
  disablePathMTUDiscovery: false

masquerade:
  type: proxy
  proxy:
    url: https://${SNI_HOST}/
    rewriteHost: true
CFG

chown -R hysteria:hysteria /etc/hysteria 2>/dev/null || true
chmod 640 /etc/hysteria/*

echo "== [6] å¯åŠ¨ Hysteria2 æœåŠ¡ =="
systemctl enable --now hysteria-server
sleep 2
systemctl status hysteria-server --no-pager || true

echo "== [7] ç”Ÿæˆ Clash è®¢é˜…æ–‡ä»¶ï¼ˆ/var/www/html/sub.yamlï¼‰ =="
install -d -m 0755 /var/www/html
cat >/var/www/html/sub.yaml <<SUB
proxies:
  - name: hy2-${PUB_IP}
    type: hysteria2
    server: ${PUB_IP}
    port: ${HY_PORT}
    password: ${HY_PASS}
    sni: ${SNI_HOST}
    alpn:
      - h3
      - h3-29
    skip-cert-verify: true
    udp: true
SUB

echo "== [8] å¯ HTTP è®¢é˜…æœåŠ¡ (8081) =="
cat >/etc/systemd/system/sub-http-8081.service <<UNIT
[Unit]
Description=Simple HTTP server for subscription on :8081
After=network.target

[Service]
Type=simple
WorkingDirectory=/var/www/html
ExecStart=/usr/bin/python3 -m http.server 8081
Restart=on-failure

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload
systemctl enable --now sub-http-8081.service

echo
echo "===== âœ… Hysteria2 å®˜æ–¹æç®€ç‰ˆéƒ¨ç½²å®Œæˆ (IPv4, SNI=www.apple.com) ====="
echo "Server: ${PUB_IP}:${HY_PORT}"
echo "Password: ${HY_PASS}"
echo
echo "Clash è®¢é˜…:  http://${PUB_IP}:8081/sub.yaml"
echo
echo "å®¢æˆ·ç«¯ç›´é“¾:"
echo "hysteria2://${HY_PASS}@${PUB_IP}:${HY_PORT}/?insecure=1&alpn=h3,h3-29&sni=${SNI_HOST}#hy2-${PUB_IP}"
echo
echo "=================================================="
EOF

  chmod +x /root/hy2_official_minimal_ipv4.sh
}

# ------------------ 4. Hy2 ä¸´æ—¶èŠ‚ç‚¹ + å®¡è®¡ + GCï¼ˆç»å¯¹æ—¶é—´ TTLï¼‰ ------------------

install_hy2_temp_audit() {
  echo "ğŸ§© å†™å…¥ /root/hy2_temp_audit_ipv4_all.sh å’Œç›¸å…³è„šæœ¬ ..."
  cat >/root/hy2_temp_audit_ipv4_all.sh << 'EOF'
#!/usr/bin/env bash
# Hy2 ä¸´æ—¶èŠ‚ç‚¹ + å®¡è®¡ + GC (IPv4) ä¸€é”®éƒ¨ç½² / è¦†ç›–ï¼ˆç»å¯¹æ—¶é—´ TTLï¼‰
set -euo pipefail

########################################
# 1) å•èŠ‚ç‚¹æ¸…ç†è„šæœ¬ï¼ˆæŒ‰ EXPIRE_EPOCH åˆ¤æ–­ï¼‰
########################################
cat >/usr/local/sbin/hy2_cleanup_one.sh << 'CLEAN'
#!/usr/bin/env bash
set -euo pipefail

TAG="${1:?need TAG}"
UNIT_NAME="${TAG}.service"
META="/etc/hysteria/${TAG}.meta"

# è‹¥éœ€è¦æ— è§†è¿‡æœŸæ—¶é—´å¼ºåˆ¶æ¸…ç†ï¼Œå¯ç”¨ï¼š
#   FORCE=1 hy2_cleanup_one.sh TAG
FORCE="${FORCE:-0}"

# 1) å¦‚æœæœ‰ meta ä¸”æ²¡æœ‰ FORCE=1ï¼Œå°±æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸ
if [[ "$FORCE" != "1" && -f "$META" ]]; then
  # åŠ è½½ EXPIRE_EPOCH ç­‰å˜é‡
  . "$META" 2>/dev/null || true

  if [[ -n "${EXPIRE_EPOCH:-}" && "$EXPIRE_EPOCH" =~ ^[0-9]+$ ]]; then
    NOW=$(date +%s)
    if (( EXPIRE_EPOCH > NOW )); then
      # è¿˜æ²¡åˆ°æœŸï¼šä¸æ¸…ç†ï¼Œç›´æ¥é€€å‡º
      echo "[hy2_cleanup_one] ${TAG} æœªåˆ°æœŸ (EXPIRE_EPOCH=${EXPIRE_EPOCH}, NOW=${NOW})ï¼Œè·³è¿‡æ¸…ç†"
      exit 0
    fi
  fi
fi

echo "[hy2_cleanup_one] å¼€å§‹æ¸…ç†: ${TAG}"

ACTIVE_STATE="$(systemctl show -p ActiveState --value "${UNIT_NAME}" 2>/dev/null || echo "")"

if [[ "${ACTIVE_STATE}" == "active" || "${ACTIVE_STATE}" == "activating" ]]; then
  if ! timeout 8 systemctl stop "${UNIT_NAME}" >/dev/null 2>&1; then
    systemctl kill "${UNIT_NAME}" >/dev/null 2>&1 || true
  fi
fi

systemctl disable "${UNIT_NAME}" >/dev/null 2>&1 || true

for f in \
  "/etc/systemd/system/${UNIT_NAME}" \
  "/etc/hysteria/${TAG}.yaml" \
  "/etc/hysteria/${TAG}.meta" \
  "/var/log/${TAG}.log"
do
  rm -f "$f" 2>/dev/null || true
done

systemctl daemon-reload >/dev/null 2>&1 || true

echo "[hy2_cleanup_one] å®Œæˆæ¸…ç†: ${TAG}"
echo "$(date '+%F %T %Z') cleanup ${TAG}" >> /var/log/hy2-gc.log 2>/dev/null || true
CLEAN
chmod +x /usr/local/sbin/hy2_cleanup_one.sh

########################################
# 2) ç»å¯¹æ—¶é—´ TTL è¿è¡ŒåŒ…è£…è„šæœ¬ï¼šhy2_run_temp.sh
#    æ¯æ¬¡å¯åŠ¨å‰æŒ‰ EXPIRE_EPOCH è®¡ç®—å‰©ä½™ç§’æ•°ï¼Œç”¨ timeout æ§åˆ¶
########################################
cat >/usr/local/sbin/hy2_run_temp.sh << 'RUN'
#!/usr/bin/env bash
set -euo pipefail

TAG="${1:?need TAG}"
CFG="${2:?need config path}"

# ç¡®ä¿ timeout å­˜åœ¨
if ! command -v timeout >/dev/null 2>&1; then
  echo "[hy2_run_temp] 'timeout' æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… coreutils åŒ…" >&2
  exit 1
fi

META="/etc/hysteria/${TAG}.meta"
if [[ ! -f "$META" ]]; then
  echo "[hy2_run_temp] meta not found: $META" >&2
  exit 1
fi

. "$META" 2>/dev/null || true

if [[ -z "${EXPIRE_EPOCH:-}" || ! "$EXPIRE_EPOCH" =~ ^[0-9]+$ ]]; then
  echo "[hy2_run_temp] bad EXPIRE_EPOCH in $META" >&2
  exit 1
fi

NOW=$(date +%s)
REMAIN=$((EXPIRE_EPOCH - NOW))

if (( REMAIN <= 0 )); then
  echo "[hy2_run_temp] $TAG already expired (EXPIRE_EPOCH=$EXPIRE_EPOCH, NOW=$NOW)"
  FORCE=1 /usr/local/sbin/hy2_cleanup_one.sh "$TAG" 2>/dev/null || true
  exit 0
fi

HY2_BIN=$(command -v hysteria || echo /usr/local/bin/hysteria)
if [[ ! -x "$HY2_BIN" ]]; then
  echo "[hy2_run_temp] hysteria binary not found" >&2
  exit 1
fi

echo "[hy2_run_temp] run $TAG for up to ${REMAIN}s (expire at $EXPIRE_EPOCH)"

exec timeout "$REMAIN" "$HY2_BIN" server --config "$CFG"
RUN
chmod +x /usr/local/sbin/hy2_run_temp.sh

########################################
# 3) åˆ›å»ºä¸´æ—¶ Hy2 èŠ‚ç‚¹ï¼šD=ç§’ hy2_mktemp.sh
########################################
cat >/usr/local/sbin/hy2_mktemp.sh << 'MK'
#!/usr/bin/env bash
set -euo pipefail
: "${D:?è¯·ç”¨ D=ç§’ hy2_mktemp.sh æ–¹å¼è°ƒç”¨ï¼Œä¾‹å¦‚ï¼šD=300 hy2_mktemp.sh}"

# æ ¡éªŒ D å¿…é¡»æ˜¯æ­£æ•´æ•°
if ! [[ "$D" =~ ^[0-9]+$ ]] || (( D <= 0 )); then
  echo "âŒ D å¿…é¡»æ˜¯æ­£æ•´æ•°ç§’ï¼Œä¾‹å¦‚ï¼šD=600 hy2_mktemp.sh" >&2
  exit 1
fi

HY2_BIN=$(command -v hysteria || echo /usr/local/bin/hysteria)
[ -x "$HY2_BIN" ] || { echo "âŒ æœªæ‰¾åˆ° hysteria å¯æ‰§è¡Œæ–‡ä»¶"; exit 1; }

TLS_CERT=""
TLS_KEY=""

if [[ -f /etc/hysteria/config.yaml ]]; then
  TLS_CERT=$(grep -E 'cert:' /etc/hysteria/config.yaml | awk '{print $2}' | head -n1 || true)
  TLS_KEY=$(grep -E 'key:'  /etc/hysteria/config.yaml | awk '{print $2}' | head -n1 || true)
fi

[[ -z "$TLS_CERT" || -z "$TLS_KEY" ]] && {
  TLS_CERT="/etc/hysteria/server.crt"
  TLS_KEY="/etc/hysteria/server.key"
}

if [[ ! -f "$TLS_CERT" || ! -f "$TLS_KEY" ]]; then
  echo "âŒ æœªæ‰¾åˆ°å¯ç”¨è¯ä¹¦ï¼Œè¯·å…ˆç¡®ä¿ä¸» Hy2 å·²å®‰è£…å¹¶ç”Ÿæˆ /etc/hysteria/server.crt / server.key"
  exit 1
fi

PORT=40000
while :; do
  USED=0

  if ss -lunH 2>/dev/null | awk '{print $5}' | sed "s/.*://g" | grep -qx "$PORT"; then
    USED=1
  fi

  if grep -R "PORT=${PORT}" /etc/hysteria/hy2-temp-*.meta 2>/dev/null >/dev/null; then
    USED=1
  fi

  if (( USED == 0 )); then
    break
  fi

  PORT=$((PORT+1))
  if (( PORT > 50050 )); then
    echo "âŒ åœ¨ 40000-50050 èŒƒå›´å†…æ²¡æœ‰ç©ºé—² UDP ç«¯å£äº†ã€‚"
    exit 1
  fi
done

PASS=$(head -c16 /dev/urandom | base64 | tr -dc 'A-Za-z0-9' | cut -c1-16)
TAG="hy2-temp-$(date +%Y%m%d%H%M%S)-$(openssl rand -hex 2)"
CFG2="/etc/hysteria/${TAG}.yaml"
UNIT="/etc/systemd/system/${TAG}.service"
META="/etc/hysteria/${TAG}.meta"

mkdir -p /etc/hysteria

ADDR=$(curl -4fsS https://ifconfig.me 2>/dev/null || hostname -I | awk '{print $1}')
NOW=$(date +%s)
EXP=$((NOW + D))

cat >"$CFG2" <<CFG
listen: ":${PORT}"
tls:
  cert: "$TLS_CERT"
  key: "$TLS_KEY"
auth:
  type: password
  password: "$PASS"

quic:
  alpn:
    - h3
    - h3-29
  initStreamReceiveWindow: 26843545
  maxStreamReceiveWindow: 26843545
  initConnReceiveWindow: 67108864
  maxConnReceiveWindow: 67108864
  maxIdleTimeout: 30s
  maxIncomingStreams: 1024
  disablePathMTUDiscovery: false

masquerade:
  type: proxy
  proxy:
    url: "https://www.apple.com/"
    rewriteHost: true
CFG

# å…ˆå†™ metaï¼Œä¿è¯ hy2_run_temp å¯åŠ¨æ—¶èƒ½è¯»åˆ° EXPIRE_EPOCH ç­‰ä¿¡æ¯
cat >"$META" <<M
TAG=$TAG
PASS=$PASS
PORT=$PORT
SERVER_ADDR=$ADDR
EXPIRE_EPOCH=$EXP
M

cat >"$UNIT" <<U
[Unit]
Description=Temp HY2 $TAG
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/sbin/hy2_run_temp.sh $TAG $CFG2
ExecStopPost=/usr/local/sbin/hy2_cleanup_one.sh $TAG
Restart=no

[Install]
WantedBy=multi-user.target
U

systemctl daemon-reload

# å…ˆ enableï¼ˆå¤±è´¥ä¸ä¼šè®©æ•´ä¸ªè„šæœ¬å´©ï¼‰
if ! systemctl enable "$TAG".service >/dev/null 2>&1; then
  echo "âš ï¸ æ— æ³• enable $TAG.serviceï¼ˆå¯ä»¥ç¨åæ‰‹åŠ¨ systemctl enable $TAG.serviceï¼‰"
fi

# å† startï¼Œå¦‚å¤±è´¥åˆ™å›æ»šæ¸…ç†
if ! systemctl start "$TAG".service; then
  echo "âŒ å¯åŠ¨ä¸´æ—¶ Hy2 æœåŠ¡å¤±è´¥ï¼Œæ­£åœ¨å›æ»š..."
  FORCE=1 /usr/local/sbin/hy2_cleanup_one.sh "$TAG" || true
  exit 1
fi

E_STR=$(TZ=Asia/Shanghai date -d "@$EXP" '+%F %T')
echo "âœ… æ–°èŠ‚ç‚¹: $TAG
åœ°å€: $ADDR:$PORT/UDP
å¯†ç : $PASS
æœ‰æ•ˆæœŸ: $D ç§’
åˆ°æœŸ: $E_STR
URL:
hysteria2://$PASS@$ADDR:$PORT/?sni=$ADDR&insecure=1#$TAG"
MK
chmod +x /usr/local/sbin/hy2_mktemp.sh

########################################
# 4) å¼ºåŠ› GCï¼šæŒ‰ meta è¿‡æœŸæ—¶é—´æ¸…ç†
########################################
cat >/usr/local/sbin/hy2_gc.sh << 'GC'
#!/usr/bin/env bash
set -euo pipefail
shopt -s nullglob

NOW=$(date +%s)

for META in /etc/hysteria/hy2-temp-*.meta; do
  unset TAG EXPIRE_EPOCH
  . "$META" 2>/dev/null || continue

  if [[ -z "${TAG:-}" ]]; then
    continue
  fi
  if [[ -z "${EXPIRE_EPOCH:-}" || ! "${EXPIRE_EPOCH}" =~ ^[0-9]+$ ]]; then
    continue
  fi

  if (( EXPIRE_EPOCH <= NOW )); then
    /usr/local/sbin/hy2_cleanup_one.sh "$TAG" || true
  fi
done
GC
chmod +x /usr/local/sbin/hy2_gc.sh

cat >/etc/systemd/system/hy2-gc.service << 'GCSVC'
[Unit]
Description=HY2 Temp Nodes Garbage Collector
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/hy2_gc.sh
GCSVC

cat >/etc/systemd/system/hy2-gc.timer << 'GCTMR'
[Unit]
Description=Run HY2 GC every 15 minutes

[Timer]
OnBootSec=5min
OnUnitActiveSec=15min
Persistent=true

[Install]
WantedBy=timers.target
GCTMR

systemctl daemon-reload
systemctl enable --now hy2-gc.timer || true

########################################
# 5) å®¡è®¡è„šæœ¬ï¼ˆä¸»æœåŠ¡ + ä¸´æ—¶èŠ‚ç‚¹ï¼‰
########################################
cat >/usr/local/sbin/hy2_audit.sh << 'AUDIT'
#!/usr/bin/env bash
set -euo pipefail
shopt -s nullglob

MAIN_VLESS="${MAIN_VLESS:-xray.service}"
MAIN_HY2="${MAIN_HY2:-hysteria-server.service}"

printf "%-40s %-10s %-6s %-12s %-10s %-20s\n" "NAME" "STATE" "PORT" "LEFT" "NOTE" "EXPIRE(China)"

print_main() {
  local NAME="$1"
  local PORT="$2"
  local NOTE="$3"
  local STATE

  if systemctl list-unit-files "$NAME" >/dev/null 2>&1; then
    STATE=$(systemctl is-active "$NAME" 2>/dev/null || echo "unknown")
    printf "%-40s %-10s %-6s %-12s %-10s %-20s\n" "$NAME" "$STATE" "$PORT" "-" "$NOTE" "-"
  fi
}

print_main "$MAIN_VLESS" "443" "vless-main"
print_main "$MAIN_HY2"  "8443" "hy2-main"

for META in /etc/hysteria/hy2-temp-*.meta; do
  unset TAG PORT EXPIRE_EPOCH
  . "$META" 2>/dev/null || continue

  if [[ -z "${TAG:-}" || -z "${PORT:-}" ]]; then
    continue
  fi

  NAME="${TAG}.service"
  STATE="$(systemctl is-active "$NAME" 2>/dev/null || echo "unknown")"
  PORT_STR="${PORT:-?}"
  NOW_TS=$(date +%s)

  if [[ -n "${EXPIRE_EPOCH:-}" && "${EXPIRE_EPOCH}" =~ ^[0-9]+$ ]]; then
    LEFT=$((EXPIRE_EPOCH - NOW_TS))
    if (( LEFT <= 0 )); then
      LEFT_STR="expired"
    else
      D=$((LEFT/86400))
      H=$(((LEFT%86400)/3600))
      M=$(((LEFT%3600)/60))
      LEFT_STR=$(printf "%02dd%02dh%02dm" "$D" "$H" "$M")
    fi
    EXPIRE_AT_FMT="$(TZ='Asia/Shanghai' date -d "@${EXPIRE_EPOCH}" '+%Y-%m-%d %H:%M:%S')"
  else
    LEFT_STR="N/A"
    EXPIRE_AT_FMT="N/A"
  fi

  printf "%-40s %-10s %-6s %-12s %-10s %-20s\n" "$NAME" "$STATE" "$PORT_STR" "$LEFT_STR" "hy2-temp" "$EXPIRE_AT_FMT"
done
AUDIT
chmod +x /usr/local/sbin/hy2_audit.sh

########################################
# 6) æ¸…ç©ºå…¨éƒ¨ä¸´æ—¶èŠ‚ç‚¹ï¼ˆå¼ºåˆ¶ï¼‰
########################################
cat >/usr/local/sbin/hy2_clear_all.sh << 'CLR'
#!/usr/bin/env bash
set -euo pipefail
shopt -s nullglob

echo "== HY2 ä¸´æ—¶èŠ‚ç‚¹æ‰¹é‡æ¸…ç†å¼€å§‹ =="

META_FILES=(/etc/hysteria/hy2-temp-*.meta)

if (( ${#META_FILES[@]} == 0 )); then
  echo "å½“å‰æ²¡æœ‰ä»»ä½•ä¸´æ—¶ HY2 èŠ‚ç‚¹ã€‚"
  exit 0
fi

for META in "${META_FILES[@]}"; do
  unset TAG
  echo "--- å‘ç° meta: ${META}"
  . "$META" 2>/dev/null || continue

  if [[ -z "${TAG:-}" ]]; then
    echo "  âš ï¸  è·³è¿‡ï¼š${META} ä¸­æ²¡æœ‰ TAG"
    continue
  fi

  echo "  -> æ¸…ç† ${TAG}"
  FORCE=1 /usr/local/sbin/hy2_cleanup_one.sh "$TAG" || true
done

systemctl daemon-reload >/dev/null 2>&1 || true
echo "âœ… æ‰€æœ‰ä¸´æ—¶ HY2 èŠ‚ç‚¹æ¸…ç†æµç¨‹å·²æ‰§è¡Œå®Œæ¯•ã€‚"
CLR
chmod +x /usr/local/sbin/hy2_clear_all.sh

echo "âœ… Hy2 ä¸´æ—¶èŠ‚ç‚¹ + å®¡è®¡ + GC è„šæœ¬éƒ¨ç½²/è¦†ç›–å®Œæˆï¼ˆç»å¯¹æ—¶é—´ TTLï¼‰ã€‚"

cat <<USE

============ ä½¿ç”¨æ–¹æ³•ï¼ˆHy2 ä¸´æ—¶èŠ‚ç‚¹ / å®¡è®¡ï¼‰ ============

1) æ–°å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼ˆä¾‹å¦‚ 600 ç§’ï¼‰ï¼š
   D=600 hy2_mktemp.sh

   - åˆ›å»ºæ—¶è®°å½• EXPIRE_EPOCH = åˆ›å»ºç¬é—´ + D ç§’
   - ä¹‹åæ¯æ¬¡é‡å¯éƒ½ä¼šæŒ‰ EXPIRE_EPOCH è®¡ç®—å‰©ä½™ TTL

2) æŸ¥çœ‹ä¸»èŠ‚ç‚¹ + æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹çŠ¶æ€ï¼ˆæŒ‰ç»å¯¹æ—¶é—´è®¡ç®—å‰©ä½™ï¼‰ï¼š
   hy2_audit.sh

3) æ­£å¸¸æƒ…å†µä¸‹ï¼š
   - hy2_run_temp.sh ä½¿ç”¨ timeout(å‰©ä½™ç§’æ•°) æ§åˆ¶èŠ‚ç‚¹å¯¿å‘½
   - è¿›ç¨‹é€€å‡ºå ExecStopPost -> hy2_cleanup_one.sh æ¸…ç†å·²è¿‡æœŸèŠ‚ç‚¹
   - hy2_gc.timer ä½œä¸ºå…œåº•ï¼Œå®šæ—¶æ‰«æ EXPIRE_EPOCH è¿‡æœŸèŠ‚ç‚¹

4) æ‰‹åŠ¨å¼ºåˆ¶æ¸…ç©ºæ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹ï¼ˆæ— è§†æ˜¯å¦è¿‡æœŸï¼‰ï¼š
   hy2_clear_all.sh

5) å¼ºåˆ¶å¹²æ‰æŸä¸€ä¸ªæœªè¿‡æœŸèŠ‚ç‚¹ç¤ºä¾‹ï¼š
   FORCE=1 hy2_cleanup_one.sh hy2-temp-YYYYMMDDHHMMSS-ABCD

==========================================================
USE

EOF

  chmod +x /root/hy2_temp_audit_ipv4_all.sh
}

# ------------------ 5. nftables é…é¢ç³»ç»Ÿï¼ˆ1 åˆ†é’Ÿä¿å­˜ countersï¼‰ ------------------

install_port_quota() {
  echo "ğŸ§© éƒ¨ç½² UDP ä¸Šè¡Œé…é¢ç³»ç»Ÿï¼ˆnftablesï¼‰..."
  apt-get update -y >/dev/null || true
  apt-get install -y nftables >/dev/null || true
  mkdir -p /etc/portquota

  if ! nft list table inet portquota >/dev/null 2>&1; then
    nft add table inet portquota
  fi
  if ! nft list chain inet portquota down_out >/dev/null 2>&1; then
    nft add chain inet portquota down_out '{ type filter hook output priority filter; policy accept; }'
  fi

  nft list ruleset > /etc/nftables.conf
  systemctl enable --now nftables >/dev/null 2>&1 || true

  cat >/usr/local/sbin/pq_add.sh <<'ADD'
#!/usr/bin/env bash
set -euo pipefail
PORT="${1:-}"; GIB="${2:-}"
if [[ -z "$PORT" || -z "$GIB" ]]; then
  echo "ç”¨æ³•: pq_add.sh <ç«¯å£> <GiB(æ•´æ•°)>" >&2; exit 1
fi
if ! [[ "$GIB" =~ ^[0-9]+$ ]]; then
  echo "âŒ GiB éœ€ä¸ºæ•´æ•°" >&2; exit 1
fi
BYTES=$((GIB * 1024 * 1024 * 1024))

nft -a list chain inet portquota down_out 2>/dev/null | \
 awk -v p="$PORT" '$0 ~ "udp sport "p" " {print $NF}' | while read -r h; do
   nft delete rule inet portquota down_out handle "$h" 2>/dev/null || true
 done

nft delete counter inet portquota "pq_down_$PORT" 2>/dev/null || true
nft add counter inet portquota "pq_down_$PORT"
nft add rule inet portquota down_out udp sport "$PORT" \
  counter name "pq_down_$PORT" quota over "$BYTES" bytes drop comment "pq-quota-$PORT"
nft add rule inet portquota down_out udp sport "$PORT" \
  counter name "pq_down_$PORT" comment "pq-track-$PORT"

cat >/etc/portquota/pq-"$PORT".meta <<M
PORT=$PORT
LIMIT_BYTES=$BYTES
LIMIT_GIB=$GIB
MODE=quota
M

# æ¯æ¬¡ä¿®æ”¹è§„åˆ™åç«‹å³ä¿å­˜ä¸€æ¬¡ï¼ˆå¸¦ countersï¼‰
nft list ruleset > /etc/nftables.conf
systemctl enable --now nftables >/dev/null 2>&1 || true

echo "âœ… å·²ä¸ºç«¯å£ $PORT è®¾ç½®é™é¢ ${GIB}GiBï¼ˆæœ¬æœº UDP ä¸Šè¡Œï¼‰"
ADD
  chmod +x /usr/local/sbin/pq_add.sh

  cat >/usr/local/sbin/pq_del.sh <<'DEL'
#!/usr/bin/env bash
set -euo pipefail
PORT="${1:-}"
if [[ -z "$PORT" ]]; then echo "ç”¨æ³•: pq_del.sh <ç«¯å£>" >&2; exit 1; fi

nft -a list chain inet portquota down_out 2>/dev/null | \
 awk -v p="$PORT" '$0 ~ "udp sport "p" " {print $NF}' | while read -r h; do
   nft delete rule inet portquota down_out handle "$h" 2>/dev/null || true
 done

nft delete counter inet portquota "pq_down_$PORT" 2>/dev/null || true
rm -f /etc/portquota/pq-"$PORT".meta

nft list ruleset > /etc/nftables.conf
systemctl enable --now nftables >/dev/null 2>&1 || true

echo "âœ… å·²åˆ é™¤ç«¯å£ $PORT çš„é…é¢"
DEL
  chmod +x /usr/local/sbin/pq_del.sh

  cat >/usr/local/sbin/pq_audit.sh <<'AUDIT'
#!/usr/bin/env bash
# ğŸ” å®æ—¶å®¡è®¡ nft quotaï¼ˆä¸Šè¡Œç»Ÿè®¡ï¼‰
set -e; shopt -s nullglob
printf "%-8s %-8s %-12s %-12s %-8s %-10s\n" \
 "PORT" "STATE" "USED(GiB)" "LIMIT(GiB)" "PERCENT" "MODE"
for META in /etc/portquota/pq-*.meta; do
  unset PORT LIMIT_BYTES MODE
  . "$META" 2>/dev/null || continue
  PORT="${PORT:-}"; [[ -z "$PORT" ]] && continue
  LIMIT_BYTES="${LIMIT_BYTES:-0}"; MODE="${MODE:-quota}"
  QUOTA_LINE="$(nft -a list chain inet portquota down_out 2>/dev/null \
    | awk -v p="$PORT" '$0~"udp sport "p" "&&$0~"pq-quota-"p{print;exit}')"
  CUR=""; QUOTA_LIMIT_BYTES=""
  if [[ -n "$QUOTA_LINE" ]]; then
    CUR="$(awk '{for(i=1;i<=NF;i++)if($i=="used"){print $(i+1);exit}}'<<<"$QUOTA_LINE")"
    read QVAL QUNIT <<< "$(awk '{for(i=1;i<=NF;i++)if($i=="over"){print $(i+1),$(i+2);exit}}'<<<"$QUOTA_LINE")"
    if [[ -n "$QVAL" && -n "$QUNIT" ]]; then
      case "$QUNIT" in
        bytes)QUOTA_LIMIT_BYTES="$QVAL";;
        kbytes)QUOTA_LIMIT_BYTES=$((QVAL*1024));;
        mbytes)QUOTA_LIMIT_BYTES=$((QVAL*1024*1024));;
        gbytes)QUOTA_LIMIT_BYTES=$((QVAL*1024*1024*1024));;
      esac
    fi
  fi
  if [[ -z "$CUR" ]]; then
    CUR="$(nft list counter inet portquota "pq_down_${PORT}" 2>/dev/null \
      | awk '/bytes/{for(i=1;i<=NF;i++)if($i=="bytes"){print $(i+1);exit}}')"
  fi
  [[ -z "$CUR" ]]&&CUR=0
  [[ -n "$QUOTA_LIMIT_BYTES" ]]&&LIMIT_BYTES="$QUOTA_LIMIT_BYTES"
  USED="$(awk -v b="$CUR" 'BEGIN{printf "%.2f",b/1024/1024/1024}')"
  if ((LIMIT_BYTES>0));then
    LIMIT_GIB="$(awk -v b="$LIMIT_BYTES" 'BEGIN{printf "%.2f",b/1024/1024/1024}')"
    PCT="$(awk -v u="$CUR" -v l="$LIMIT_BYTES" 'BEGIN{printf "%.1f%%",(u*100.0)/l}')"
  else LIMIT_GIB="0";PCT="N/A";fi
  STATE="ok"
  if [[ "$MODE"=="quota" ]]&&((LIMIT_BYTES>0))&&((CUR>=LIMIT_BYTES));then
    STATE="dropped"
  elif [[ "$MODE"!="quota"||"$LIMIT_BYTES"=="0" ]];then
    STATE="track"
  fi
  printf "%-8s %-8s %-12s %-12s %-8s %-10s\n" \
    "$PORT" "$STATE" "$USED" "$LIMIT_GIB" "$PCT" "$MODE"
done
AUDIT
  chmod +x /usr/local/sbin/pq_audit.sh

  # å®šæœŸä¿å­˜ nft è§„åˆ™ï¼ˆåŒ…æ‹¬ countersï¼‰åˆ° /etc/nftables.confï¼ˆ1 åˆ†é’Ÿä¸€æ¬¡ï¼‰
  cat >/usr/local/sbin/pq_save.sh <<'SAVE'
#!/usr/bin/env bash
set -euo pipefail

TMP="/etc/nftables.conf.tmp"
DST="/etc/nftables.conf"
LOG="/var/log/pq-save.log"

if ! nft list ruleset > "$TMP"; then
  echo "$(date '+%F %T %Z') [pq-save] nft list ruleset å¤±è´¥ï¼Œæœªæ›´æ–° $DST" >> "$LOG"
  exit 1
fi

mv "$TMP" "$DST"
echo "$(date '+%F %T %Z') [pq-save] saved nftables ruleset to $DST" >> "$LOG"
SAVE
  chmod +x /usr/local/sbin/pq_save.sh

  cat >/etc/systemd/system/pq-save.service <<'PQSVC'
[Unit]
Description=Save nftables ruleset with counters

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/pq_save.sh
PQSVC

  cat >/etc/systemd/system/pq-save.timer <<'PQTMR'
[Unit]
Description=Periodically save nftables ruleset (with counters)

[Timer]
OnBootSec=30s
OnUnitActiveSec=60s
Persistent=true

[Install]
WantedBy=timers.target
PQTMR

  systemctl daemon-reload >/dev/null 2>&1 || true
  systemctl enable --now pq-save.timer >/dev/null 2>&1 || true

  cat <<USE

============ ä½¿ç”¨æ–¹æ³•ï¼ˆUDP ä¸Šè¡Œé…é¢ / å®¡è®¡ï¼‰ ============

1) ä¸ºç«¯å£æ·»åŠ é…é¢ï¼ˆä¾‹å¦‚é™åˆ¶ 40000 ç«¯å£ 50GiBï¼‰ï¼š
   pq_add.sh 40000 50

2) æŸ¥çœ‹æ‰€æœ‰ç«¯å£ä½¿ç”¨æƒ…å†µï¼š
   pq_audit.sh

3) åˆ é™¤æŸä¸ªç«¯å£çš„é…é¢ï¼š
   pq_del.sh 40000

è¯´æ˜ï¼š
- ç»Ÿè®¡çš„æ˜¯æœ¬æœºå‘å‡ºçš„ UDP ä¸Šè¡Œæµé‡ï¼ˆchain: output, udp sportï¼‰
- æ¯æ¬¡ add/del ä¼šç«‹å³ä¿å­˜ nft è§„åˆ™åˆ° /etc/nftables.conf
- é¢å¤–æœ‰ pq-save.timer æ¯ 1 åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜å¿«ç…§ï¼Œ
  é‡å¯åä¼šä»æœ€è¿‘å¿«ç…§æ¢å¤ï¼Œå·²ä½¿ç”¨é‡æœ€å¤šä¸¢å¤±çº¦ 1 åˆ†é’Ÿå†…çš„ç»Ÿè®¡

==========================================================
USE
}

# ------------------ ä¸»æµç¨‹ ------------------

main() {
  check_debian11
  need_basic_tools
  download_upstreams

  install_update_all
  install_vless_script
  install_hy2_script
  install_hy2_temp_audit
  install_port_quota

  cat <<'DONE'

==================================================
âœ… æ‰€æœ‰è„šæœ¬å·²ç”Ÿæˆå®Œæ¯•ï¼ˆé€‚ç”¨äº Debian 11ï¼‰

å¯ç”¨å‘½ä»¤ä¸€è§ˆï¼š

1) ç³»ç»Ÿæ›´æ–° + æ–°å†…æ ¸ï¼š
   update-all
   reboot

2) VLESS Reality (IPv4, SNI=www.apple.com)ï¼š
   bash /root/onekey_reality_ipv4.sh

3) Hysteria2 å®˜æ–¹æç®€ + Clash è®¢é˜…ï¼š
   bash /root/hy2_official_minimal_ipv4.sh

4) Hy2 ä¸´æ—¶èŠ‚ç‚¹ + å®¡è®¡ + GCï¼ˆç»å¯¹æ—¶é—´ TTLï¼‰ï¼š
   bash /root/hy2_temp_audit_ipv4_all.sh
   # éƒ¨ç½²åï¼š
   D=600 hy2_mktemp.sh     # æ–°å»º 600 ç§’ä¸´æ—¶èŠ‚ç‚¹ï¼ˆæŒ‰ç»å¯¹æ—¶é—´ç”Ÿæ•ˆï¼‰
   hy2_audit.sh            # æŸ¥çœ‹å…¨éƒ¨èŠ‚ç‚¹çŠ¶æ€ï¼ˆå‰©ä½™æ—¶é—´æŒ‰ EXPIRE_EPOCH è®¡ç®—ï¼‰
   hy2_clear_all.sh        # æ‰‹åŠ¨å¼ºåˆ¶æ¸…ç©ºæ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹

5) UDP ä¸Šè¡Œé…é¢ï¼ˆnftables + 1 åˆ†é’Ÿä¿å­˜ countersï¼‰ï¼š
   pq_add.sh 40000 50      # ç«¯å£ 40000 é™åˆ¶ 50GiB ä¸Šè¡Œ
   pq_audit.sh             # æŸ¥çœ‹æ‰€æœ‰ç«¯å£é…é¢ä½¿ç”¨
   pq_del.sh 40000         # åˆ é™¤ 40000 ç«¯å£é…é¢

æ‰€æœ‰ SNI/ä¼ªè£…åŸŸåå·²ç»Ÿä¸€ä¸ºï¼š www.apple.com

ğŸ¯ å»ºè®®é¡ºåºï¼š
   1) update-all && reboot
   2) è·‘ VLESS / Hy2 ä¸¤ä¸ªä¸€é”®è„šæœ¬
   3) éœ€è¦ä¸´æ—¶èŠ‚ç‚¹å°±è·‘ hy2_temp_audit_ipv4_all.sh å† D=xxx hy2_mktemp.sh
   4) éœ€è¦é™é¢å°±ç”¨ pq_add.sh / pq_audit.sh / pq_del.sh

==================================================
DONE
}

main "$@"
